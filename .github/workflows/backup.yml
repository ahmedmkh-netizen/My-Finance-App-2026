name: Drive Auto Backup 2026
on:
  push:
    branches: [ main ]
  schedule:
    # تحديث تلقائي يومي الساعة 12 ليلاً
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-api-python-client google-auth-oauthlib google-auth-httplib2

      - name: Create Zip File
        # سيقوم بضغط كل الملفات بما فيها ملف JSON الجديد الخاص بالبيانات
        run: zip -r backup_2026.zip . -x "*.git*" "node_modules/*"

      - name: Upload to Google Drive
        env:
          CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          FOLDER_ID: ${{ secrets.GOOGLE_FOLDER_ID }}
        run: |
          python - <<EOF
          import os, sys
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          try:
              info = {
                  "client_id": os.environ['CLIENT_ID'].strip(),
                  "client_secret": os.environ['CLIENT_SECRET'].strip(),
                  "refresh_token": os.environ['REFRESH_TOKEN'].strip(),
                  "token_uri": "https://oauth2.googleapis.com/token",
              }
              creds = Credentials.from_authorized_user_info(info)
              service = build('drive', 'v3', credentials=creds)

              file_metadata = {
                  'name': f"Finance_Backup_v{os.environ.get('GITHUB_RUN_NUMBER')}.zip",
                  'parents': [os.environ['FOLDER_ID'].strip()] if os.environ.get('FOLDER_ID') else []
              }
              media = MediaFileUpload('backup_2026.zip', mimetype='application/zip')
              
              print("Uploading synchronized backup...")
              file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
              print(f"✅ Success! File ID: {file.get('id')}")

          except Exception as e:
              print(f"❌ Error: {str(e)}")
              sys.exit(1)
          EOF